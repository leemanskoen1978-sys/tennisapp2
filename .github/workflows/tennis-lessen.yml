# Tennis Vlaanderen lessen scraper - draait maandelijks in de cloud
name: Tennis Lessen Scraper

on:
  schedule:
    - cron: "0 6 1 * *"
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Python setup
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tennis_lessen_scraper/requirements.txt

      - name: Install Playwright browsers
        run: playwright install chromium

      - name: Debug - welke e-mail code draait?
        run: |
          echo "=== Versie-check email_sender ==="
          grep -n "Gmail API\|Probeer e-mail\|email_sender:" tennis_lessen_scraper/email_sender.py || true
          head -70 tennis_lessen_scraper/email_sender.py | tail -20

      - name: Run scraper
        env:
          CI: true
          GITHUB_ACTIONS: true
          TENNIS_USERNAME: ${{ secrets.TENNIS_USERNAME }}
          TENNIS_PASSWORD: ${{ secrets.TENNIS_PASSWORD }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
        run: python run_tennis_scraper.py --scrape

      - name: Zet Excel in workspace voor artifact
        if: success()
        run: |
          EXCEL=$(find . -name "tennis_lessen.xlsx" 2>/dev/null | head -1)
          if [ -n "$EXCEL" ]; then
            cp "$EXCEL" "$GITHUB_WORKSPACE/tennis_lessen.xlsx"
            echo "Excel gekopieerd naar workspace"
          else
            echo "Waarschuwing: tennis_lessen.xlsx niet gevonden"
            ls -laR .
          fi

      - name: Upload Excel als download
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: tennis-lessen-excel
          path: tennis_lessen.xlsx
